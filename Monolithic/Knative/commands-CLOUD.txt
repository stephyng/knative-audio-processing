# Command list for the Monolithic Application (Cloud - AWS EC2)

# Create a working directory in which you are going to deploy Pulumi
mkdir pulumi
cd pulumi

pulumi new kubernetes-python

# Paste your Pulumi Access Token or login in your browser to Pulumi

# Fill out the details of your project
# Name: knative-audio-processing-aws-ec2
# Desc.: A Knative audio processing application
# Desired stack name: dev

# Copy your __main__.py file from the Git repo to the pulumi project
sudo cp ~/knative-audio-processing/Auto-Deployment/Pulumi/Monolithic/__main__.py __main__.py

# Start creating your pulumi project
pulumi up 

# Choose "yes" when prompted to do so

# Wait for all pods and triggers to fully load and achieve working status

# Login in your browser to minio
# http://<EC2_IPv4>:30912

# Login to the MinIO Client from your console
mc alias set local http://127.0.0.1:30911 minioadmin minioadmin

# Create your bucket
mc mb local/knative-audio-processor

# Configure a service waiting for an upload to the MinIO Bucket
mc admin config set local notify_webhook:knative endpoint="http://knative-audio-processor.default.svc.cluster.local/minio-event"
mc admin service restart local
mc event add local/knative-audio-processor arn:minio:sqs::knative:webhook --event put

# You can automate the process above with the use of a bash script
~/knative-audio-processing/Auto-Deployment/Bash/Minio/minio-setup.sh

# UPLOAD a .mp3 file to be processed or use:
# (Or use your browser)
mc cp ~/knative-audio-processing/MP3-files/tts.mp3 local/knative-audio-processor/

# If you want to check out the logs of a given microservice pod use:
kubectl logs -l serving.knative.dev/service=knative-audio-processor -c user-container --tail=100